<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Week 19 Using kernel density estimates to quantify an exposure for Spatial Epi | EPI 563: Spatial Epidemiology, Fall 2023</title>
<meta name="author" content="Michael Kramer">
<meta name="description" content="As discussed in Disease Mapping IV, kernel density estimation can be used to map diseases (e.g. outcomes), but it can also be used to create continuous surfaces of an epidemiologic exposure or...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="Week 19 Using kernel density estimates to quantify an exposure for Spatial Epi | EPI 563: Spatial Epidemiology, Fall 2023">
<meta property="og:type" content="book">
<meta property="og:description" content="As discussed in Disease Mapping IV, kernel density estimation can be used to map diseases (e.g. outcomes), but it can also be used to create continuous surfaces of an epidemiologic exposure or...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Week 19 Using kernel density estimates to quantify an exposure for Spatial Epi | EPI 563: Spatial Epidemiology, Fall 2023">
<meta name="twitter:description" content="As discussed in Disease Mapping IV, kernel density estimation can be used to map diseases (e.g. outcomes), but it can also be used to create continuous surfaces of an epidemiologic exposure or...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.1/transition.js"></script><script src="libs/bs3compat-0.5.1/tabs.js"></script><script src="libs/bs3compat-0.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">EPI 563: Spatial Epidemiology, Fall 2023</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">How to use this eBook</a></li>
<li><a class="" href="download-ebook.html">Download eBook</a></li>
<li class="book-part">Getting ready…</li>
<li><a class="" href="software-installation.html">Software installation</a></li>
<li><a class="" href="installing-packages-for-this-course.html">Installing packages for this course</a></li>
<li class="book-part">Weekly Modules</li>
<li><a class="" href="locating-spatial-epidemiology.html"><span class="header-section-number">1</span> Locating Spatial Epidemiology</a></li>
<li><a class="" href="cartography-for-epidemiology-i.html"><span class="header-section-number">2</span> Cartography for Epidemiology I</a></li>
<li><a class="" href="cartography-for-epidemiology-ii-spatial-ethics.html"><span class="header-section-number">3</span> Cartography for Epidemiology II: Spatial Ethics</a></li>
<li><a class="" href="disease-mapping-i-aspatial-empirical-bayes.html"><span class="header-section-number">4</span> Disease Mapping I: Aspatial Empirical Bayes</a></li>
<li><a class="" href="disease-mapping-ii-spatial-empirical-bayes.html"><span class="header-section-number">5</span> Disease Mapping II: Spatial Empirical Bayes</a></li>
<li><a class="" href="disease-mapping-iii-introduction-to-fully-bayesian-mapping.html"><span class="header-section-number">6</span> Disease Mapping III: Introduction to Fully Bayesian mapping</a></li>
<li><a class="" href="disease-mapping-iv-kernel-density-estimation.html"><span class="header-section-number">7</span> Disease Mapping IV: Kernel Density Estimation</a></li>
<li><a class="" href="spatial-structure-and-clustering-i-morans-i-and-lisa.html"><span class="header-section-number">8</span> Spatial Structure and Clustering I: Moran’s I and LISA</a></li>
<li><a class="" href="spatial-structure-and-clustering-ii-spatial-scan-statistics.html"><span class="header-section-number">9</span> Spatial Structure and Clustering II: Spatial scan statistics</a></li>
<li><a class="" href="spatreg1.html"><span class="header-section-number">10</span> Spatial Regression I: Spatializing aspatial regression residuals</a></li>
<li><a class="" href="spatial-regression-ii-spatial-econometric-regression.html"><span class="header-section-number">11</span> Spatial Regression II: Spatial econometric regression</a></li>
<li><a class="" href="spatial-regression-iii-geographically-weighted-regression.html"><span class="header-section-number">12</span> Spatial Regression III: Geographically Weighted Regression</a></li>
<li class="book-part">Appendices</li>
<li><a class="" href="reproducibility-and-projects-in-r.html"><span class="header-section-number">13</span> Reproducibility and Projects in R</a></li>
<li><a class="" href="introduction-to-r-notebooks.html"><span class="header-section-number">14</span> Introduction to R Notebooks</a></li>
<li><a class="" href="formatting-markdown-and-notebooks.html"><span class="header-section-number">15</span> Formatting Markdown and Notebooks</a></li>
<li><a class="" href="sf-overview.html"><span class="header-section-number">16</span> Tips for working with sf data class</a></li>
<li><a class="" href="dplyr.html"><span class="header-section-number">17</span> Tips for using dplyr</a></li>
<li><a class="" href="intro-tmap.html"><span class="header-section-number">18</span> Tips for using tmap</a></li>
<li><a class="active" href="kde-extract.html"><span class="header-section-number">19</span> Using kernel density estimates to quantify an exposure for Spatial Epi</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mkram01/EPI563-SpatialEPI">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="kde-extract" class="section level1" number="19">
<h1>
<span class="header-section-number">Week 19</span> Using kernel density estimates to quantify an exposure for Spatial Epi<a class="anchor" aria-label="anchor" href="#kde-extract"><i class="fas fa-link"></i></a>
</h1>
<p>As discussed in <strong>Disease Mapping IV</strong>, kernel density estimation can be used to map diseases (e.g. <em>outcomes</em>), but it can also be used to create continuous surfaces of an epidemiologic <em>exposure</em> or <em>covariate</em>. If you create a continuous geographically weighted surface of an exposure, you might wonder how to <strong>extract</strong> or join it to polygon or point data for further analysis.</p>
<blockquote>
<p>GOAL: The purpose of this appendix is to take an exposure that is defined by points (e.g. locations of power plants, health clinics, or waste sites), and to connect it to an sf data frame that has outcome (e.g. aggregated to a polygon) for further analysis.</p>
</blockquote>
<div id="prepare-the-exposure-surface" class="section level2" number="19.1">
<h2>
<span class="header-section-number">19.1</span> Prepare the exposure surface<a class="anchor" aria-label="anchor" href="#prepare-the-exposure-surface"><i class="fas fa-link"></i></a>
</h2>
<p>This tutorial assumes you have data as a points object. Recall that if you retrieved data with latitude and longitude as numbers in columns, you can use <code>sf</code> tools to create an spatial points object.</p>
<div id="step-1." class="section level3" number="19.1.1">
<h3>
<span class="header-section-number">19.1.1</span> Step 1.<a class="anchor" aria-label="anchor" href="#step-1."><i class="fas fa-link"></i></a>
</h3>
<p>Because we are doing kernel density on points, we will use the <code>sparr</code> package which requires that our data get converted from <code>sf</code> to the older <code>sp</code></p>
<div class="sourceCode" id="cb456"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># df_sf is an sf object where each row is a point feature representing the location of an FQHC health care clinic</span></span>
<span></span>
<span><span class="co"># This converts sf to sp</span></span>
<span><span class="va">df_sp</span> <span class="op">&lt;-</span> <span class="va">df_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="st">"Spatial"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="step-2." class="section level3" number="19.1.2">
<h3>
<span class="header-section-number">19.1.2</span> Step 2.<a class="anchor" aria-label="anchor" href="#step-2."><i class="fas fa-link"></i></a>
</h3>
<p>Create an observation window (<code>owin</code>) that defines the outer bounds of the study area. <strong>NOTE</strong>: the point dataset with the exposure and the polygon representing the study area must be in the same CRS projection.</p>
<p>In the code below, the object <code>study_area</code> is a polygon defining the outer bounds of the included study area. This is akin to the county boundary we used in Disease Mapping IV.</p>
<div class="sourceCode" id="cb457"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create an observation window within which the kernel density estimation will be constrained</span></span>
<span><span class="va">study_owin</span> <span class="op">&lt;-</span> <span class="fu">maptools</span><span class="fu">::</span><span class="fu"><a href="http://maptools.r-forge.r-project.org/reference/as.owin.html">as.owin.SpatialPolygons</a></span><span class="op">(</span><span class="va">study_area</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="step-3." class="section level3" number="19.1.3">
<h3>
<span class="header-section-number">19.1.3</span> Step 3.<a class="anchor" aria-label="anchor" href="#step-3."><i class="fas fa-link"></i></a>
</h3>
<p>Now follow the steps from Disease Mapping IV (and the corresponding lab) to create a <code>ppp</code> object and then create a kernel density. Finally, you will convert your kernel density to a <code>raster</code> object.</p>
<div class="rmdnote">
<p><strong>What does this kernel density represent?</strong></p>
<p>The interpretation of the resulting surface depends on what data you are analyzing. Imagine it is points representing Federally Qualified Health Centers (FQHCs). By converting these discrete locations into a kernel density surface, you will be quantifying the average density of FQHCs per square unit area (e.g. per square km).</p>
<p>Therefore, the meaning of each <code>raster</code> grid value is in fact the density in the vicinity of that particular grid cell. And the “<em>vicinity</em>” is defined by the kernel bandwidth.</p>
</div>
<p>Here we create the <code>ppp</code> object:</p>
<div class="sourceCode" id="cb458"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the birth ppp object</span></span>
<span><span class="va">fqhc_ppp</span> <span class="op">&lt;-</span> <span class="fu">ppp</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">df_sp</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, </span>
<span>             y <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">df_sp</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>             window <span class="op">=</span> <span class="va">study_owin</span><span class="op">)</span></span></code></pre></div>
<p>In the code below, we use a fixed bandwidth of 5km (note that <code>h0=5000</code> only corresponds to 5km if the projection unit is in square meters). <strong>Note that you could use any of the bandwidth diagnostics, or use adaptive bandwidths in this setting, just as we did for Disease Mapping IV.</strong></p>
<div class="rmdnote">
<p><strong>Density or Intensity?</strong></p>
<p>Remember, we had some discussion in Disease Mapping IV about the distinction between “density” and “intensity”. The “<em>intensity</em>” is the ratio of units (e.g. FQHCs int his case) per area (e.g. per square km). A true “<em>density</em>” is the intensity at one location relative to all of the study area. That means that the “<em>density</em>” will always sum to 1 across the study area (e.g. it is a formal statistical probability density).</p>
<p>When we are creating a surface of an exposure, we usually want the units to be meaningful. Thus, the <em>intensity</em> is more relevant as it tells us how many units there are in space. The code below sets <code>density=FALSE</code> to indicate this preference.</p>
</div>
<div class="sourceCode" id="cb459"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fqhc_kde</span> <span class="op">&lt;-</span> <span class="fu">bivariate.density</span><span class="op">(</span>pp <span class="op">=</span> <span class="va">fqhc_ppp</span>, </span>
<span>                              h0 <span class="op">=</span> <span class="fl">5000</span>, </span>
<span>                              density <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                              edge <span class="op">=</span> <span class="st">'diggle'</span><span class="op">)</span></span></code></pre></div>
<p>Now we can take the <code>img</code> object that was output from <code>bivariate.density()</code> and convert it to a <code>raster</code> format. Recall that because the <code>crs()</code> coordinate reference information gets stripped away in this process, we simply need to re-define it.</p>
<div class="sourceCode" id="cb460"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fqhc_kde_raster</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="op">(</span><span class="va">fqhc_kde</span><span class="op">$</span><span class="va">z</span><span class="op">)</span></span>
<span><span class="fu">crs</span><span class="op">(</span><span class="va">fqhc_kde_raster</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"EPSG:5070"</span></span></code></pre></div>
<p>If you plot the resulting raster, the values in the legend will be quite small, because for example, they are telling us how many FQHCs there are in every square meter!! Obviously there are not many. But if you multiply by <span class="math inline">\(1,000,000\)</span>, the values will be the number of FQHCs per square kilometer. That still might be small so you could even multiply by a bigger number to make it the number of FQHCs per 10 or per 100 square km.</p>
</div>
<div id="step-4." class="section level3" number="19.1.4">
<h3>
<span class="header-section-number">19.1.4</span> Step 4.<a class="anchor" aria-label="anchor" href="#step-4."><i class="fas fa-link"></i></a>
</h3>
<p>Everything up until now has been very similar to Disease Mapping IV. But now we want to <strong>extract</strong> the values. In other words we want to know what the average continuous FQHC intensity is at some given point where we measured a health outcome. If our health outcomes are aggregated to polygons (e.g. rates per census tract or county), we might choose to use the centroid of that polygon as the place to extract. If, on the other hand, the points were the actual street address of individuals, we would use those locations for extraction. In other words, the goal is to extract from the raster to specific points.</p>
<p>Here the target outcome unit of analysis is a polygon named <code>tracts-ms</code>. For extraction we want it to be points, and so we will use the centroid of every tract as the point of reference.</p>
<div class="sourceCode" id="cb461"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_tract_point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">df_tracts_ms</span><span class="op">)</span></span></code></pre></div>
<p>Our goal now is to extract values from a <code>raster</code> (e.g. to merge or join the point to the raster and connect the raster cell value undelying the point). The point object needs to be class <code>sp</code> so if it is not, convert it first (e.g. <code>d_sp &lt;- df_tract_point %&gt;% as("Spatial")</code>).</p>
<p>Now use the <code><a href="https://tidyr.tidyverse.org/reference/extract.html">extract()</a></code> function from the <code>raster</code> package:</p>
<div class="sourceCode" id="cb462"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_value</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">fqhc_kde_raster</span>, <span class="va">df_tract_point</span><span class="op">)</span></span></code></pre></div>
<p>The code above specifies the raster first, and then the object containing the point information second. This should produce a vector with as many values as there were points in <code>df_tract_point</code>. Now you simply join them onto your analytic dataset that has the outcome to bring the exposure and the outcome together!</p>
<div class="sourceCode" id="cb463"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tracts_ms</span><span class="op">$</span><span class="va">fqhc_inensity</span> <span class="op">&lt;-</span> <span class="va">exposure_value</span></span></code></pre></div>

<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-brewer_evaluation_2002" class="csl-entry">
Brewer, Cynthia A, and Linda Pickle. 2002. <span>“Evaluation of <span>Methods</span> for <span>Classifying</span> <span>Epidemiological</span> <span>Data</span> on <span>Choropleth</span> <span>Maps</span> in <span>Series</span>.”</span> <em>Annals of the Association of American Geographers</em> 92 (4): 662–81. <a href="https://doi.org/10.1111/1467-8306.00310">https://doi.org/10.1111/1467-8306.00310</a>.
</div>
</div>
</div>
</div>
</div>







  <div class="chapter-nav">
<div class="prev"><a href="intro-tmap.html"><span class="header-section-number">18</span> Tips for using tmap</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#kde-extract"><span class="header-section-number">19</span> Using kernel density estimates to quantify an exposure for Spatial Epi</a></li>
<li>
<a class="nav-link" href="#prepare-the-exposure-surface"><span class="header-section-number">19.1</span> Prepare the exposure surface</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#step-1."><span class="header-section-number">19.1.1</span> Step 1.</a></li>
<li><a class="nav-link" href="#step-2."><span class="header-section-number">19.1.2</span> Step 2.</a></li>
<li><a class="nav-link" href="#step-3."><span class="header-section-number">19.1.3</span> Step 3.</a></li>
<li><a class="nav-link" href="#step-4."><span class="header-section-number">19.1.4</span> Step 4.</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mkram01/EPI563-SpatialEPI/blob/master/57-kde-for-epi-exposure.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mkram01/EPI563-SpatialEPI/edit/master/57-kde-for-epi-exposure.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>EPI 563: Spatial Epidemiology, Fall 2023</strong>" was written by Michael Kramer. It was last built on Last updated: 2023-08-14.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
